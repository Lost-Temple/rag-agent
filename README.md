# RAG 系统

一个基于Langchain的可配置RAG（检索增强生成）系统，支持文档处理、向量化、混合检索等功能，使用Neo4j作为图数据库存储，并提供RESTful API和MCP远程调用接口。支持使用Ollama本地大模型进行文档处理和问答。

## 功能特点

- 支持多种文档格式（PDF、DOCX、TXT、MD）的处理和切分
- 使用先进的向量化模型进行文档嵌入
- 支持混合检索策略（向量检索 + 重排序）
- 使用Neo4j图数据库存储文档关系和元数据
- 提供RESTful API接口用于文档上传和管理
- 支持通过MCP进行远程检索调用
- 支持使用Ollama本地大模型进行文档嵌入和问答
- 高度可配置，支持自定义模型和参数

## 安装

1. 克隆项目并安装依赖：

```bash
pip install -r requirements.txt
brew install --cask libreoffice  # 这个命令用于安装LibreOffice，在使用doc文件上传时需要安装
```


2. 安装并启动Neo4j数据库

3. 创建配置文件：

将示例配置文件复制为 `.env`，并根据需要修改配置：

```bash
cp .env.example .env
```

## 配置

主要配置项（在 `.env` 文件中设置）：

- `EMBEDDING_MODEL`：向量化模型名称
- `RERANKER_MODEL`：重排序模型名称
- `NEO4J_URI`：Neo4j数据库连接URI
- `NEO4J_USER`：Neo4j用户名
- `NEO4J_PASSWORD`：Neo4j密码
- `VECTOR_STORE_TYPE`：向量存储类型（chroma/faiss/milvus）
- `VECTOR_STORE_PATH`：向量存储路径
- `ORIGINAL_DOCUMENTS_PATH`：原始文档存储路径
- `MILVUS_HOST`：Milvus服务器地址
- `MILVUS_PORT`：Milvus服务器端口
- `MILVUS_USER`：Milvus用户名
- `MILVUS_PASSWORD`：Milvus密码
- `MILVUS_COLLECTION`：Milvus集合名称
- `MILVUS_INDEX_TYPE`：Milvus索引类型（IVF_FLAT/HNSW/FLAT等）
- `MILVUS_METRIC_TYPE`：Milvus度量类型（IP/L2等）
- `MILVUS_INDEX_PARAMS`：Milvus索引参数（JSON格式，如{"nlist": 1024}）
- `MILVUS_SEARCH_PARAMS`：Milvus搜索参数（JSON格式，如{"nprobe": 16}）
- `API_PORT`：RESTful API服务端口
- `MCP_PORT`：MCP服务端口
- `USE_OLLAMA`：是否使用Ollama模型（true/false）
- `OLLAMA_BASE_URL`：Ollama服务地址
- `OLLAMA_MODEL`：Ollama LLM模型名称
- `OLLAMA_EMBEDDING_MODEL`：Ollama嵌入模型名称

## 使用方法

### 1. 启动服务

通过main.py统一入口启动所有服务：

```bash
python main.py
```

支持以下可选参数：
- --port: 指定服务端口（默认8000）
- --debug: 启用调试模式

### 2. 上传文档

#### 2.1 使用RESTful API上传文档(同步接口)：

```bash
curl -X POST "http://localhost:8000/documents/upload" \
     -H "accept: application/json" \
     -H "Content-Type: multipart/form-data" \
     -F "file=@/path/to/your/document.pdf"
```
response:
```json
{
  "status": "success",
  "doc_id": "7509f818-452a-49f2-a307-38df19672e66",
  "message": "Document processed and stored successfully",
  "chunks_count": 25,
  "summary_generated": true
}
```

#### 2.2 使用RESTful API上传文档(异步接口)：
```bash
curl -X POST "http://localhost:8000/documents/upload?async=true" \
     -H "accept: application/json" \
     -H "Content-Type: multipart/form-data" \
     -F "file=@/path/to/your/document.pdf"
```
response:
```json
{
  "status": "processing",
  "doc_id": "db45eae8-2203-4393-9e5a-17bd87500436",
  "message": "文档已接收，正在后台处理"
}
```
### 3. 获取文档摘要列表
分页查询：
```shell
curl -X GET "http://localhost:8000/documents/summaries/all?page=1&&page_size=10" \
     -H "accept: application/json"
```
response:
```json
{
    "total": 2,
    "page": 1,
    "page_size": 10,
    "summaries": [
        {
            "doc_id": "6fd316ce-a2e4-41b1-92b6-f4196d39583e",
            "filename": "城市商业银行清算中心票据交易系统业务需求书.doc",
            "summary": "该文档详细描述了城市商业银行资金清算中心票据交易系统的业务需求书，旨在开发一个支持票据交易（包括纸票和电票）并实现与上海票据交易所直连接口的系统。项目预计从2017年7月到2018年5月完成，涵盖需求分析、系统设计、开发测试等多个阶段。文档详细描述了系统的功能模块和操作流程，并定义了相关术语和技术要求。\n\n系统的主要功能包括机构管理、纸质信息登记、票据交易、登记托管、清算结算等服务给接入行。具体功能模块如下：\n\n1. **承兑登记与影像维护**：系统提供多种操作按钮，支持批量处理票据信息的加载、删除、修改和提交；新增和导入票据信息界面，并上传票据正面和其他补充影像。详细说明了权限要求和流转状态。\n\n2. **票据质押与解除**：包括质押信息登记、修改、删除及复核等操作流程，涵盖质押登记撤回和查询功能。文档还描述了票据质押解除信息的录入、查询和复核过程，并涉及贴现登记的相关内容。\n\n3. **票据贴现业务**：详细说明了贴现申请人的基本信息录入要求；影像文件上传规范及其处理规则；信息录入后的校验与错误处理机制；复核操作流程及结果影响。此外，还涵盖了贴现信息登记复核和贴现影像维护的具体步骤和权限管理。\n\n4. **承兑保证登记**：涉及票据在不同业务环节中的管理规则和操作流程，包括删除、复核、撤销和查询等操作。文档详细描述了承兑保证登记的操作流程及其功能要求，并明确了各操作的功能描述、交易渠道和介质、处理要求、权限要求以及界面要求。\n\n5. **库存移入与移库信息查询**：系统提供了查询并签收本机构待签收的库存移入批次，更新票据状态；查询、导出本机构存库移出、移入库、退票及退票签收等票据清单的功能。文档还涉及了保证增信业务的相关查询功能和操作。\n\n整体而言，这些描述旨在确保相关业务处理的准确性和高效性，并规范票据在不同环节中的处理方式，确保操作的准确性和安全性。\n\n此外，该文档详细介绍了多个重要功能模块及其操作流程，涵盖了从票据查询、签收到付款确认、结清登记、止付处理、追索业务、质押式回购和买断式回购等各个环节的具体要求和操作步骤：\n\n1. **承兑付款确认**：描述了发起和应答付款确认申请的逻辑，包括影像验证和实物验证两种方式，并详细列出了不同场景下的处理流程和条件限制。保管行需根据需要补录影像或进行实物鉴定后重新提交付款确认申请；付款行应对票据信息进行核对并作出审批决定。\n\n2. **结清登记与止付处理**：系统允许操作员根据特定条件查询票据，记录纸质票据的结清信息，并上传至票交所系统。提供了结清登记撤回机制及止付登记与解除功能。止付登记需在特定情况下更新风险票据标识。\n\n3. **追索业务**：描述了线上和线下追索的具体操作流程，包括持票人在票据到期日后的特定时间内可向被追索人发出追索通知。提供了解除止付信息登记、纸质信息登记查询及止付信息新增查询等功能。\n\n4. **质押式回购与买断式回购**：详细说明了买断式回购票据的查询和赎回申请流程，包括逆回购方和正回购方机构对赎回申请进行签批及应答操作。提供了提前/逾期赎回的具体步骤及其相关的权限管理、界面设计等细节。\n\n5. **资金清算与票据交易处理**：描述了从申请到最终清算失败或成功的各个阶段的资金清算状态，以及未处理、已锁定、结算成功或失败等票据清算状态。提供了查询功能和票据交易类型，并详细说明了转贴现卖出流程的具体操作步骤。\n\n6. **其他功能模块**：包括提示付款记账、提示付款撤回与应答、追索结清登记及权属初始登记等操作流程及其权限管理要求。提供了托管票据查询、票据详细信息查询、托管账户余额查询以及质押式回购提前/逾期赎回等功能的界面设计和输入输出条件。\n\n文档整体确保了票据处理过程中的准确性和安全性，提供了多种操作和查询方式以支持不同场景下的业务需求。通过详细的流程描述、权限设置及界面要求，帮助用户准确理解和执行相关业务处理。\n\n该文档全面描述了票据交易系统中的多个关键功能模块及其操作流程，确保在票据转卖、质押式回购买入和卖出等各个环节的操作规范性和高效性。主要内容涵盖了以下几个方面：\n\n1. **字段定义与必填项**：详细定义了票据清单中包括的多种字段（如票据号码、票面金额等），并指出了部分字段为必填项，确保数据输入的准确性和完整性。\n\n2. **操作按钮及其功能**：提供了多种操作按钮（如保存、导出、修改、提交审批等），并详细说明了每个按钮的功能和使用场景。这些按钮支持不同业务场景下的操作需求，并确保用户能够顺利完成各项任务。\n\n3. **约束检查规则**：列出了对合同信息的多项约束条件，以确保数据准确性和流程合规性。例如，在转卖合同时，票据类型和介质在挑选后不允许修改；提交前需进行多项检验，包括票据清单、计息情况、日期范围以及合同一致性等。\n\n4. **业务审批与报价**：详细描述了从建立转卖合同到最终记账处理的整个业务流程及其各环节的操作要求。客户经理负责建立转卖合同并挑选拟卖出的票据清单后提交审批；行内各级审批人员进行审批，通过后发送对话报价至票交所；系统对报价单中的票据进行时间校验，并在交易对方修改报价时提供相应提示和操作选项。\n\n5. **意向询价功能**：包括新增、查询和管理意向询价的功能说明。交易员可以向市场、特定群组或单一交易员发出买断式回购交易意向的询价，系统会根据审批结果流转至相应节点，并支持匹配模式下的询价处理机制。\n\n6. **记账与成交处理**：收到票交所成交通知报文后，会计人员完成账务处理并反馈结果。成交信息生成成交单及票据清单，确保交易双方的信息准确无误。\n\n7. **权限设置与界面要求**：明确了操作员需要具备的特定权限才能访问相关功能，并详细说明了交易渠道和介质的选择规则。界面上设计了新增、修改、成交等操作按钮，支持多种业务场景下的操作需求。\n\n8. **查询与打印功能**：提供了多个查询功能模块（如转贴现卖出回购到期明细查询、转贴现卖出回购余额查询等），并允许操作员根据条件下载详细信息。此外还涵盖了意向询价和成交单的打印功能，确保用户能够方便地查看和导出所需数据。\n\n文档整体结构清晰，详细列出了各功能模块的操作细节、权限要求以及界面设计需求等关键信息，为票据交易系统的用户提供全面的操作指南和技术支持。\n\n该文档还提供了系统的扩展与运营要求的关键指标和服务等级标准，确保面向客户服务的功能需求得到满足，并参照电子商业汇票系统原有标准进行交易量、高峰时段等具体要求的设定。",
            "created_at": "2025-04-09T10:59:51.795219",
            "updated_at": "2025-04-09T10:59:51.795233"
        },
        {
            "doc_id": "20d11bdf-8525-40f6-bfe4-97c4c1282b71",
            "filename": "城商行资金清算中心电子商业汇票服务平台系统需求规格说明书V1.0_票据托收业务.doc",
            "summary": "这份《城商行资金清算中心电子商业汇票服务平台系统需求规格说明书》V1.0版由恒生电子股份有限公司编制，旨在为城市商业银行提供一个全面的电子商业汇票服务管理平台。该文档详细描述了系统的功能需求、优先级划分及技术细节，并提供了明确的开发和实施指导依据。\n\n文档分为多个模块，包括清算中心管理和电子商业汇票两大核心部分。关键功能涵盖权限安全管理、基础数据导入、工作流管理、计费管理以及票据操作（如承兑出票、撤票、背书转让、贴现等）。其中，优先级为“必须”的功能需求在项目资源或进度受限时需优先实现。\n\n票据管理系统详细描述了票据录入、批量导入、信封生成与处理等功能。具体包括支持复制和新增录入的票据录入界面；通过Excel文件进行批量导入，并提供数据校验及失败记录查看；信封管理操作涉及编辑、生成、EMS打印等步骤，以及托收出库与冲正、发出托收和撤消信封功能。\n\n实物票据处理流程涵盖撤消托收交易、收款登记、收款记账、退票登记与入库、企业客户付款申请等功能。文档详细说明了各功能模块的具体需求要点，包括输入输出描述、界面设计以及系统交互时的操作流程和注意事项。\n\n提示付款申请、撤消提示付款申请及收款记账等核心功能的实现细节也得到了详尽阐述。提示付款申请需授权人员核对审查；撤消提示付款申请支持多步校验和批量操作，票据状态回滚机制确保交易安全；收款记账涉及行内账务处理及额度管理。\n\n此外，文档还详细描述了电子票据划款登记及划款登记冲正的流程设计、界面设计、性能需求和运行环境要求。划款登记功能支持按票号等条件查询票据列表，并提供票据明细信息查询；划款登记冲正则允许多笔批量操作并处理失败情况。\n\n文档强调，系统需满足特定的性能需求（如接口中浮点数精度到小数点后两位、联机交易响应时间不超过3秒），并在运行环境中确保设备和软件支持以及全面的安全性要求。总体而言，该文档为系统的开发与实施提供了详尽的技术指导。",
            "created_at": "2025-04-08T17:46:32.868236",
            "updated_at": "2025-04-08T17:46:32.868262"
        }
    ]
}
```

### 4. 使用Ollama进行问答
通过API进行问答：

```bash
curl -X 'POST' \
  'http://localhost:8000/llm/question' \
  -H 'accept: application/json' \
  -H 'Content-Type: application/json' \
  -d '{
  "question": "什么是票据系统",
  "top_k": 5
}'
```
response:
```json
{
  "answer": "票据系统是指根据中国票据交易系统直连接口规范（1.0版）建立的用于处理票据业务（包括纸票和电票）的系统。该系统能够完成承兑、贴现、转贴现、再贴现、回购、质押、保证等业务模块，并且实现了与上海票据交易所的全交易接口直连，为接入银行提供服务。此外，该系统还支持多法人管理架构，确保每个法人的数据和信息独立性，并通过参数化设计满足不同成员单位的管理要求。",
  "context": [
    {
      "content": "根据《上海票据交易所关于印发〈中国票据交易系统直连接口规范（1.0版）〉和〈直连接口项目工作计划表（首批）〉的通知》（票交所发〔2017〕32号），上海票据交易所的票据交易系统直连接口功能将于2018年1月上线。目前，城市商业银行资金清算中心（以下简称清算中心）已具备集中接入资质，为了给接入行提供集中直连接入上海票据交易所的服务，需开发城市商业银行清算中心票据交易系统。  \n\n二、项目简介\n\n根据中国票据交易系统直连接口规范（1.0版），结合接入行的业务需求，建立票据交易系统，完成票据业务（纸票和电票）承兑、贴现、转贴现、再贴现、回购、质押、保证等业务模块，实现与票交所的全交易接口直连。\n\n三、目标市场和用户\n\n拟通过清算中心票据系统直连集中接入上海票据交易所的银行。 \n\n四、产品定价\n\n    不涉及。   \n\n五 、产出分析和投入预期\n\n六、产品类型（或产品清册编号）\n\n七、支持币种\n\n人民币 \n\n八、产品期限\n\n根据票据交易系统使用情况确定\n\n九、销售地域、\n\n 全国\n\n十、业务预期进度要求",
      "metadata": {
        "source": "./data/original_documents/6fd316ce-a2e4-41b1-92b6-f4196d39583e/城市商业银行清算中心票据交易系统业务需求书.doc",
        "pk": 456886474143607700
      },
      "vector_score": 0.5986719727516174,
      "rerank_score": 0.7488580346107483,
      "final_score": 0.6445990324020385
    },
    {
      "content": "1.3术语定义\n\n1.4术语定义\n\n输入输出格式描述：\n\n输入/输出：输入，输出，输入/输出；\n\n数据类型： (字符)，（数字），（日期）；\n\n操作类型：必输项），（可选项）；\n\n界面展示形式：（文本框），（下拉列表框）（日期控件），（图像）；\n\n系统概述\n\n2.1系统概述\n\n系统现阶段主要实现票据业务（纸票和电票）承兑、贴现、转贴现、再贴现、回购、质押、保证等业务模块，根据中国票据交易系统直连接口规范（1.0版）,完成与票交所的全交易接口直连。向接入行提供服务，包括机构管理（或有）、纸质信息登记、票据交易、登记托管、清算结算、计费缴费6个子系统。\n\n系统需要支持多法人。在客户管理、参数设置、查询报表等多个方面支持多法人的管理架构，严格区分各法人的身份，确保每个法人数据和信息的独立性。系统采用参数化设计和管理，通过参数设置满足成员单位的不同的管理要求。\n\n2.2系统主要接口\n\n参考中国票据交易系统直连接口规范（1.0版）、《电票平台网银服务(企业持票)接口标准V2.0.3》、《电票平台网银服务(企业持票)-批量操作接口标准_V1.0》。\n\n2.3系统主要功能",
      "metadata": {
        "source": "./data/original_documents/6fd316ce-a2e4-41b1-92b6-f4196d39583e/城市商业银行清算中心票据交易系统业务需求书.doc",
        "pk": 456886474143607700
      },
      "vector_score": 0.6523615717887878,
      "rerank_score": 0.7169240713119507,
      "final_score": 0.6061383783817291
    },
    {
      "content": "3.2数据统计类\n\n见3.1.5.1.4和3.1.5.2.4 章节。\n\n3.3清算和对帐\n\n3.3.1日终对账\n\n一、功能描述\n\n票交所系统在日终向参与者下发对账文件，系统接收到对账文件后，逐条进行核对。对账遵循以票交所信息为准原则，如系统发现缺失下行报文，可向票交所申请补发。系统应同时提供手动触发功能。若系统自动对账出现问题，可通过手工触发交易触发对账，此交易仅为应急使用。\n\n票交所系统在日终向参与者下发托管账户余额对账文件, 系统接收到对账文件后，将本系统余额与对账文件中的余额进行核对。\n\n每月末票交所系统下发托管票据明细对账文件，系统接收到对账文件后，将本系统票据明细与对账文件中的票据明细进行核对。\n\n二、交易渠道和介质\n\n　　无\n\n三、处理要求\n\n     1系统接收到票交所下发的对账文件，自动触发核对任务，对报文进行逐条核对，对于核对不符的报文，以票交所信息为准，调整相应报文的状态。 若缺失下行报文，系统应自动发送报文核对明细申请报文申请己方向票交所发送的上行报文，或通过报文核对明细申请报文申请票交所向己方发送的下行报文，收到票交所补发的报文后进行相应的调整。",
      "metadata": {
        "source": "./data/original_documents/6fd316ce-a2e4-41b1-92b6-f4196d39583e/城市商业银行清算中心票据交易系统业务需求书.doc",
        "pk": 456886474143608000
      },
      "vector_score": 0.5891209840774536,
      "rerank_score": 0.516109049320221,
      "final_score": 0.48454003930091855
    },
    {
      "content": "票据类别：必输项，单选框。选择项包括银票和商票。\n\n票据号码：必输项， 16 位数字格式。第七位和票据类别标志一致， 5 银票 6商票。\n\n票据金额：必输项，金额格式。最大金额为 10 亿以内，小数保留 2 位。\n\n票据到期日：必输项，日期格式。不得小于出票日期和系统工作日期，出票\n\n日期和到期日控制不超过 6 个月（对月对日）。\n\n承兑行/付款人开户行行号：必输项， 12 位数字格式。可点击下拉框从机构列表中模糊查询机构名称和机构大额行号选择录入。\n\n承兑行/付款人开户行行名：必输项，文本格式，系统自动反显承兑行行号对应的行名。\n\n保证日期：必输项，日期格式。不能大于系统工作日，默认为系统工作日。\n\n被保证人名称：必输项，文本格式。\n\n录入项补充规则：\n\na）可用 TAB 键、回车键和鼠标控制光标移动逐项录入。\n\nb）文本格式的大小参考电票系统报文录入最大值。",
      "metadata": {
        "source": "./data/original_documents/6fd316ce-a2e4-41b1-92b6-f4196d39583e/城市商业银行清算中心票据交易系统业务需求书.doc",
        "pk": 456886474143607740
      },
      "vector_score": 0.5884968638420105,
      "rerank_score": 0.4647601842880249,
      "final_score": 0.4487830698490142
    },
    {
      "content": "[输入域]\n\n1.票据种类：必输项，单选项，选择项包括银票和商票。默认显示为银票。\n\n2.票据号码：必输项，16位数字格式。第七位和票据种类标志一致，5银票6商票。系统对重号和止付票据做校验控制。银票前三位和承兑行行号前三位一致，商票不做校验。\n\n3.出票日期：必输项，YYYY-MM-DD日期格式。不能大于系统工作日，默认为系统工作日。\n\n4.票据到期日：必输项，YYYY-MM-DD日期格式。不得小于出票日期和系统工作日期，出票日期和到期日控制不超过6个月（对月对日，例如出票日为10月31日，到期日最长为4月30日）\n\n5.票据金额：必输项，金额格式，小数保留2位。\n\n6.出票人名称：必输项，文本格式。\n\n7.出票人账号：必输项，英文字母和数字格式。\n\n8.出票人社会信用代码：必输项，18位数字格式。",
      "metadata": {
        "source": "./data/original_documents/6fd316ce-a2e4-41b1-92b6-f4196d39583e/城市商业银行清算中心票据交易系统业务需求书.doc",
        "pk": 456886474143607700
      },
      "vector_score": 0.5801038146018982,
      "rerank_score": 0.2383365035057068,
      "final_score": 0.2928044080734252
    }
  ]
}
```

## API文档

RESTful API文档可在服务启动后访问：

```
http://localhost:8000/docs
```

## 许可证

